<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AI 領袖屬性面板</title>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyZBh3TzIOpmP9qzZ8YZPeZbVbs2J_gVbjsWw0ZJzWlD9eB_LSJ7-wePJj8oYTyT9Do/exec";

window.onload = function() {
  const urlParams = new URLSearchParams(window.location.search);
  const userId = urlParams.get('id'); 
  
  // 🛡️ 鐵則 1：優先初始化外觀，確保蛋第一時間出現
  updateEggVisuals(); 
  updateHatch(4); // 預設 4% 基礎裂痕

  if (userId) {
    document.getElementById('btn-back').href = "Lobby.html?id=" + encodeURIComponent(userId);
    fetchData(userId);
  }
};

function formatWealth(value) {
  if (value === null || value === undefined || isNaN(value)) return "0";
  let num = parseFloat(value);
  if (num >= 100000000) return (num / 100000000).toFixed(2) + " 億";
  if (num >= 10000) return (num / 10000).toFixed(0) + " 萬";
  return num.toLocaleString();
}

async function fetchData(id) {
  try {
    const response = await fetch(`${API_URL}?action=get_leader_data&id=${encodeURIComponent(id)}`);
    const res = await response.json();
    
    if (res.success) {
      document.getElementById('real-name').innerText = res.name || "數位領袖";
      document.getElementById('team-code-display').innerText = res.teamCode || id;
      document.getElementById('est-income').innerText = "NT$ " + (Number(res.income) || 0).toLocaleString();
      document.getElementById('bonus-paid').innerText = "NT$ " + (Number(res.bonusPaid) || 0).toLocaleString();
      
      const scNum = typeof res.sc === 'string' ? Number(res.sc.replace(/,/g, '')) : Number(res.sc);
      document.getElementById('sc-value').innerText = formatWealth(scNum || 0);
      document.getElementById('group-total').innerText = res.groupTotal || 1;
      document.getElementById('sys-total').innerText = res.sysTotal || 0;
      
      // 🐣 更新孵化進度與蛋殼裂痕
      let hatchProgress = Math.min(100, 4 + (Number(res.groupTotal) || 0));
      updateHatch(hatchProgress);

      // ✈️ 旅遊點數對接
      let travelPoints = Number(res.travel) || 0;
      let travelProgress = Math.min(100, (travelPoints / 300) * 100);
      document.getElementById('travel-percent').innerText = travelPoints + " / 300 點";
      document.getElementById('travel-fill').style.width = travelProgress + "%";

    }
  } catch (error) { 
    console.error("API Error:", error);
    document.getElementById('real-name').innerText = "領袖連接中...";
    updateHatch(4); // 斷網也要有蛋
  }
}

// 🛡️ 補回消失的繪圖函數 1：處理裂痕與進度條
function updateHatch(progress) {
  const fill = document.getElementById('hatch-fill');
  const percent = document.getElementById('hatch-percent');
  const cracks = document.getElementById('egg-cracks');
  
  if (fill) fill.style.width = progress + "%";
  if (percent) percent.innerText = progress + "%";
  if (cracks) cracks.style.opacity = (progress / 100).toString();
}

// 🛡️ 補回消失的繪圖函數 2：處理蛋的 3D 光澤
function updateEggVisuals() {
  const hour = new Date().getHours();
  const egg = document.getElementById('dynamic-egg');
  if (!egg) return;

  if (hour >= 6 && hour < 18) {
    egg.style.background = "radial-gradient(circle at 20% 20%, #ffffff 0%, #fff0b3 20%, #d4af37 60%, #8b6508 100%)";
    egg.style.boxShadow = "inset -15px -15px 40px rgba(0,0,0,0.8), 0 10px 30px rgba(212, 175, 55, 0.4)";
  } else {
    egg.style.background = "radial-gradient(circle at 80% 20%, #e0e0e0 0%, #707070 30%, #202020 80%, #000000 100%)";
    egg.style.boxShadow = "inset 15px -15px 40px rgba(0,0,0,0.9), 0 5px 25px rgba(0, 229, 255, 0.2)";
  }
}
</script>
</body>
</html>
